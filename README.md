## Сбор пользовательской активности и потоковая передача видео

---

## Область ответственности

Данный компонент системы отвечает за:

- сбор и передачу пользовательской активности при просмотре видеоконтента;
- потоковую (*streaming*) передачу видеофайлов из хранилища пользователю;
- обеспечение работы системы под высокой нагрузкой с возможностью горизонтального масштабирования.

Компонент спроектирован с учетом:
- высокой пропускной способности;
- большого объема трафика;
- необходимости минимизации задержек.

---

## Сбор пользовательской активности

### Типы событий

Во время взаимодействия пользователя с видеоплеером формируются следующие события:

- **play** — начало просмотра фильма;
- **progress** — прогресс просмотра (периодическое событие);
- **pause / stop** — остановка просмотра;
- **heartbeat** — периодическое подтверждение активности пользователя;
- **error** — ошибки воспроизведения или сети.

### Структура события

Каждое событие содержит:

- `user_id`
- `movie_id`
- `timestamp`
- дополнительные параметры  
  *(позиция воспроизведения, причина остановки и т.д.)*

---

## Архитектура передачи событий

Сбор пользовательской активности реализован в **асинхронном режиме**, чтобы не блокировать пользовательский интерфейс.

### Архитектурная схема
Client → Event API → Kafka → Consumers (аналитика / мониторинг)


### Процесс обработки

1. Клиент отправляет событие через HTTP API.
2. Backend валидирует данные.
3. Событие публикуется в Kafka.
4. Консьюмеры обрабатывают события независимо  
   (аналитика, мониторинг, рекомендации).

---

## Почему используется Kafka

Kafka используется как брокер сообщений, потому что позволяет:

- обрабатывать десятки и сотни тысяч событий в секунду;
- масштабировать обработку событий независимо от сервиса;
- обеспечивать надежную доставку сообщений;
- хранить события для последующей аналитики.

---

## Heartbeat-события

Heartbeat отправляется клиентом с фиксированным интервалом во время просмотра.

### Назначение

- расчёт фактического времени просмотра (*watch time*);
- выявление обрывов соединения;
- корректная аналитика вовлеченности;
- возможность адаптации качества видеопотока.

---

## Потоковая передача видео

### Принцип работы

Видео **не передается целиком**.  
Используется потоковая передача с сегментацией контента.

### Процесс воспроизведения

1. Клиент запрашивает метаданные фильма.
2. Получает ссылку на видеопоток или манифест.
3. Видео загружается частями (чанками).
4. Возможна перемотка без повторной загрузки файла.

---

## Протокол передачи видео

Используются:

- **HTTP Range Requests**
- или адаптивные протоколы **HLS / MPEG-DASH**

Это позволяет:
- снизить сетевую нагрузку;
- адаптироваться к скорости интернета;
- уменьшить время старта воспроизведения.

---

## Хранилище видео

Видеофайлы хранятся в объектном хранилище (S3 / MinIO).

Для оптимизации:
- используется CDN для кеширования популярных сегментов;
- backend отвечает только за выдачу ссылок и контроль доступа.

---

## Масштабирование и нагрузка

- Метаданные и управляющие запросы кешируются (Redis).
- Видео-трафик не проходит через backend и выносится на CDN.
- Kafka масштабируется за счет увеличения числа consumers.

---

## Запуск модуля

### Требования

- Python 3.10+
- Kafka (локально или в Docker)
- Docker (опционально)

### Установка зависимостей

```bash
pip install -r requirements.txt

